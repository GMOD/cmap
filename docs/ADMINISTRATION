                CMAP ADMINISTRATION AND DATA CURATION

# $Revision: 1.2 $

This document is intended to help you understand how to use the data
curation tools provided with CMap.  There are two tools you will use:
the "cmap_admin.pl" command-line interface and the web-base
administration interface.  The first is used for all long-running
processes that aren't practical to address over the HTTP protocol.  It
employs a "wizard"-like approach to accomplishing various tasks by
asking the curator a series of closed-ended questions and performing
the desired action using the answers provided.  The web admin tool is
meant to provide a point-and-click interface for performing the more
mundane administrative tasks or for viewing the data.  Lastly, you can
customize many aspects of CMap by altering the your "cmap.conf" file.
All of this is discussed in further detail in this document.

1.  STARTING OUT

If you've just installed CMap, then your database is probably
completely empty.  So let's start by discussing what you need to do to
get a usable installation with your data.  This document assumes that
you've already been through all the steps described in the INSTALL
document, so you should be able to pull up the web-based admin tool by
pointing your browser to "http://your.host.name/cmap/admin."
Depending on whether or not you decided to protect that URL, you may
have to enter a username and password when prompted by your browser.

2.  WEB-ADMIN TOOL

The home page for the web-based CMap administration tool has links for
all the different actions you can take:

*   Create New Map Set
*   View Map Sets
*   View Species
*   View Map Types
*   View Feature Types
*   View Correspondence Evidence Types
*   View Database Cross-References
*   Search for a Feature
*   Exit to Map Viewer

Each link is self-explanatory.  On each "View" page, you have access
to edit and delete the information there.  Each page will be discussed
in detail later.  For the moment, let's just focus on what you need to
import your first data set.  To do that, you'll need to first set up
the species and map types.

3.  SETTING UP SPECIES

Click on "View Species" from the home page of the web-admin tool.  As
you currently have no species to view, you should see the message "No
species to show."  To add a new species, click on the "Create New
Species" link at the top of the page.  You should now see a page
entitled "Species Create" with a form for the following fields:

*   Acc. ID (opt.): This is the public accession ID for the species.
    Once established, it should never change as it will be used in all
    the publicly accessible links.

*   Common Name: This is the non-scientific name of the species. This
    field will be used most often as a prefix to the map names. If you
    plan on having more than one species that could go by the same
    common name (e.g., two species of "wheat"), you should differentiate
    them here, too.

*   Full Name: This should be the full genus and species name for the
    species

*   Display Order (opt.): This is the order in which you'd like this
    species to appear in listings, e.g., on Gramene we prefer "rice" to
    appear before other species as it is our model organism

*   NCBI Taxon ID (opt.): For disambiguating the species for users, it's
    not really used anywhere

The fields marked "(opt.)" do not require you to enter a value.  If
one is really required for the database (e.g., the "accession_id"),
then a reasonable default will be provided (e.g., the primary key
value for accession IDs).  When you are done, hit the "Submit" button.
If there are errors, they will be reported to you and you will have to
correct them before submitting again.  If there are no errors, your
entry will be accepted and you will be returned to the "Species View"
page.

Note: On all the pages with clickable column headers, clicking on the
      column names will resort the data by the column.

If you are unhappy with any of the data you see, you can click on the
"Edit" link of the record that displeases you and correct the faults.
If you have created an unnecessary species, you can delete it by
clicking on the "Delete" link.  After confirming that you really wish
to delete the species, it will be *permanently* removed from the
database.  

Note: There is no "undo" function for deletes, so be sure whenever you
      decide to remove an object from the database that you really mean
      it. When an object has other objects that rely on it (e.g.,
      species records are linked to map sets), you will not be allowed
      to remove the object until all dependencies to it are removed
      (e.g., no more map sets use the species you want to remove).

Once you've set up all the species you wish to have in your database,
click on the "Home" link in the upper-left corner to return to the
web-admin home page.

4.  SETTING UP MAP TYPES

Click on "View Map Types" from the home page of the web-admin tool.
As you currently have no map types to view, you should see the message
"No map types to show."  To add a new species, click on the "Create
New Map Types" link at the top of the page.  You should now see a page
entitled "Map Type Create" with a form for the following fields:

*   Map Type: This is the name of the map type. Common values are
    "Genetic," "Physical," "Cytogenic," "Sequence," etc. It doesn't
    matter at all what you call your map types, so use whatever names
    carry the most significance for your research community.

*   Map Units: The units of measurement for this type of map.  This
    text will display at the bottom of non-relational maps, so it's
    best to keep this short, like "cM" for "centiMorgans."

*   Is Relational Map: This field determines whether or not maps of
    this type can stand alone (like most genetic maps) or if they are a
    special kind of map set that CMap calls "relational," meaning that
    the maps can only be shown *in relation to* some other map (of the
    first, "non-relational" kind, no less :-). Examples of this include
    physical fingerprint contig maps (FPC), QTLs, and haplotypes. These
    maps are usually composed of many smaller fragments that have some
    correspondences to other maps. As such, they are just drawn
    directly across from and to a size relative to the distance their
    correspondences cover on the reference map. To see how "relational"
    maps are rendered, please visit the CMap installation on the
    Gramene website (http://www.gramene.org/cmap). From there, inspect
    the Matrix and choose a comparison to any map of the type
    "Physical." Drill down until you are taken to the viewer showing
    the reference map (probably some "genetic" map) and the physical
    contigs. Notice how their sizes vary according to the
    correspondences to the genetic map.

*   Display Order: Like the same field in the "species" table, this
    determines the order that maps of this type will be displayed,
    e.g., on Gramene it is preferred that "Genetic" maps be listed
    before "Physical" which should come before "Sequence" (even
    though a simple alphabetical listing could accomplish the same
    thing in this case).

*   Shape: This determines how maps of this type will be drawn. You
    can choose to make maps of each type visually distinct by
    specifying different shapes and colors. There are three choices
    for shape: box, dummbell and I-beam. A box will be trimmed in
    black and will be filled with the color of your choice (or a
    reasonable default). A dumbbell or an I-beam will be rendered only
    in the maps color (no trim).

*   Width (opt.): How wide a map will be drawn.

*   Color (opt.): The color a map will be drawn.
                                  
When you have filled in all the required values, press "Submit."  If
there are errors, you will have to correct them;  otherwise you will
be taken to the "Map Types View" page where your new map type will be
listed.  

Once you've set up all the map types you wish to have in your
database, click on the "Home" link in the upper-left corner to return
to the web-admin home page.

5.  CREATING A NEW MAP SET

Once you have species and map types set up, you are ready to create a
new map set.  Everything in CMap is designed to be generic, so a "map
set" is simply a collection of maps.  What you group together is
entirely up to you.  On Gramene, map sets tend to correspond to
published studies of organisms and contain maps that represent
chromosomes, linkage groups, FPC contigs, and such.  As the database
design allows only one species and one map type to be linked to a map
set, it is best to keep these narrowly defined.

To create a new map set, click on the "Create New Map Set" link from
the admin home page or from the "Map Sets View" page.  If you have
failed to set up species or map types, you will be prompted to do so
before continuing.  You will see the following fields:

*   Map Set Name:         

*   Short Name:         
                     
*   Accession ID (opt.):         

*   Species:         

*   Map Type:         

*   Published On:         

*   Display Order:         

*   Can Be Reference Map:         

*   Is Enabled:         

*   Remarks (opt.):         

*   Shape (opt.):

*   Width (opt.):

*   Color (opt.):


1. IMPORTING DATA

To learn how to import your own data, please read DATA_IMPORT in the
"docs" directory for information on importing your data.  If you would
like to see examples of data suitably formatted for importing into
CMap, all the raw data from the Gramene project
(http://www.gramene.org/) have been included with this distribution in
the "data/datasets/gramene" directory.  You can use this data to
ensure that your installation is working, or if you'd like examples of
how to format your own data.  

In addition, the entire Gramene database has been made available as a
dump of "INSERT" statements which you can feed directly into your
database.  This dump is located in the download section of the GMOD
site as "Sample Data Files" under the "cmap" project.  If you are
using MySQL, you can import the database in one step (after creating
it, of course, with the commands described earlier):

    $ mysql -uroot -p < gramene-dump.sql

It might be helpful for you to create a test database and import the
Gramene dataset in order to play around with a fully loaded database.
Once you are comfortable, you can drop the database and create another
for your own data.

The dump of the Gramene site was created using a script in the "bin"
directory called "cmap_dump.pl."  You might find it useful if you need
to move your data around, like from a development machine to a
production server.  It is especially useful for moving your data
between different DBMSs, as I used it to dump the Gramene database
from Oracle into my own MySQL database.  The tool basically mimics
some of the functionality of MySQL's "mysqldump" facility.  Run
"perldoc cmap_dump.pl" for more documentation on this tool.  The
script will not be copied into a system directory, so if you want to
use it yourself, you'll have to copy it to some directory manually.
Perhaps after the tool has matured a bit, I'll put it into the
installation routine.

2. FEATURE TYPES

-   Both "drawing_lane" and "drawing_priority" take positive integers
-   The lower the number for the lane, the closer to the map the
    feature will be drawn
-   The lower the number for the priority, the sooner the feature will
    be drawn in the lane
-   Lanes are not absolute, they are only used to sort the features on
    a map;  therefore, if you have only "Centromeres" and "Markers" in 
    lane #1, on any map with either of those types of features, they
    will be drawn *on* the map;  on any map without those types, the 
    feature type with the next highest lane number will be drawn *on*
    the map.  The same is true as you move into higher lanes;  if 
    the lanes move like "1," "4," "7," you will have only 3 lanes with
    no gaps.

2. DATABASE CROSS-REFERENCES

It is possible to set up links from features to other datasources
outside of CMap.  These are called "database cross-references."  They
can be set up in several different ways:

    1)  For a feature type and a species, e.g., all the rice markers

    2)  For a feature type and a map set, e.g., all the markers in rice
        map set "Foo"

    3)  For one specific feature, e.g., the "ABC" marker on map "3" of
        rice map set "Foo"

In the case of the first two, you can create multiple cross-references
and all will display on the "feature detail" page;  the last case only
allows a single cross-reference.  In all cases, the more specific
references beat out all others, so any cross-references created like
#2 will beat out those from #1, but the "ABC" marker will only use
those set up as #3.  That is, *only* the most specific
cross-references will be shown, so if you wanted to include the
records from #1 with a marker in the "Foo" map set, you'd need to
duplicate the URLs from #1 for the "Foo" map set.

When setting up database cross-references, you'll have to use some
extra syntax in the URL field to indicate the field to link out on.
Here's an example from Gramene for linking to GrainGenes:

    http://www.graingenes.org/cgi-bin/WebAce/webace?db=graingenes \
    &class=Locus&object=[% feature.feature_name %]

(The backslash is not part of the URL.  I'm using it to break up the
line and help you see the syntax.)

Here's how the Gramene project links to its own contig viewer:

    /perl/contigview?clone=[% feature.feature_name %]

Notice that you can use either absolute (first) or relative (second)
URLs.  The funny brackets ("[%" and "%]") are from Template Toolkit,
the templating system used for the comparative maps.  This allows for
an extremely flexible system.  For example, at Gramene one URL looks
like this:

    http://www.genome.arizona.edu/cgi-bin/WebFPC/WebFPC_Direct.cgi? \
    name=rice&contig=[% feature.map_name.replace("ctg","") %] \
    &clone=[% feature.feature_name %]

The contig names look like "ctg198," but only integers are legal
arguments to the "contig" argument above.  We use the "replace"
virtual method to get rid of the "ctg" part (or just replace it with
nothing).  To find our more about Template Toolkit, execute "perldoc
Template::Manual" on your system.  To find out more about Template
Toolkit's virtual methods, type "perldoc Template::Manual::VMethods."

Here are the fields you can use in the URL:

   feature_id
   accession_id
   map_id
   feature_type_id
   feature_name
   alternate_name
   is_landmark
   start_position
   stop_position
   dbxref_name
   dbxref_url
   feature_type
   map_name
   map_aid (map accession_id)
   map_set_id
   map_set_aid (map set accession_id)
   map_set_name (actually the "short_name")
   species_id
   species_name (actually the "common_name")

3. ESTABLISHING LANDMARKS

You can define certain features on your maps to be "landmarks."  These
can then be used by the end user to show maps less dense with feature
labels, tagging only those that you as the curator have decided are
the most important.  Simply set the "is_landmark" field to "1" to
define a feature as a landmark.

4. LINKING IN

Most likely, you'll want to link directly into the CMap viewer from
some other part of your site.  To link to just one map, make it the
"reference" map like so by using the accession IDs for the map's parent
"set" and the map itself.  Give the feature (mutant) name to highlight
it;  for more than one, separate with commas.  You'll want to make
sure that the user can see all the feature labels, so include "all" as
the "label_features" argument.

    URI:  /cmap/viewer?
    Args: ref_map_set_aid=<map_set_accession_id>
          ref_map_aid=<map_accession_id>
          highlight=<mutant_name>
          label_features=<none, all, or landmarks>
    E.g.:
http://www.gramene.org/cmap/viewer?ref_map_aid=13&ref_map_set_aid=cu-dh-2001&highlight=RM9&label_features=all

Note: I use the abbreviation "aid" to represent "accession_id."

To further include some number of comparative maps, you provide them
in the "comparative_maps" argument, which is a single structured
string that lists all the comparative maps and their placement
relative to the reference map.  Here I'd like to introduce the concept
of "slots," where the maps (or map sets) fall into a slot moving in
positive and negative direction away from the reference map, which is
in slot "0," like so:

                -      -        -         -
                |      |        |         |
                |      |      - |  -      |
                |      |      | -  |      |
                |      |      |    |      |
                |      |      |    -      |
                -      -      -           -
               -1      0         1        2
       <----negative --+---------positive----->


The above would be representative of genetic maps in slots -1, 0, and
2, and a physical map in slot 1.  Slots are separated in the string by
URI-escaped colons and the integral parts of the slot by URI-escaped
equal signs.  Like so

         "comparative_maps="
         +
             .-  <slot_number> + 
             |  "%3D" + 
       slot  |  <"map_aid" or "map_set_aid"> + 
             |  "%3D" +
             `-  <map_aid or map_set_aid>
         +

         "%3A"

         +

        <next slot>

Here is a sample that puts "Rice-Cornell RFLP 2001-1" on the left
(slot "-1") and "Rice-CTIR 2000-1" on the right (slot "1"):

    comparative_maps=1%3Dmap_aid%3D423%3A-1%3Dmap_aid%3D1

The middle part of the slot is one of the literal strings
"map_set_aid" or "map_aid."  If you wanted to display just a single
map in a slot, use the string "map_aid" and the map's accession ID.
If you want a whole map set in a slot (e.g., a physical map set like
"I-Map"), then use the string "map_set_aid" and the map set's
accession ID.  You can use the admin interface ("/cmap/admin") to
easily find the accession IDs.

5. CUSTOMIZING YOUR INSTALLATION

You should edit "cmap.conf" with the proper connection data for your
database and to reflect your own preferences for how maps are drawn.
Each entry in the configuration file is commented to help you
understand its purpose and the possible values and default values are
also provided.  If you don't understand a configuration, you can just
leave it alone and use the default.  Remember to restart Apache
whenever you make a change to this file as these are constants and
don't change for the life of the Apache process.

You can change the way maps and features are drawn based on
their types.  Use the web-based admin tool to edit each "map type"
and "feature type" that you create.  Experiment with the colors,
shapes, and sizes.

All the HTML displayed by the application is contained in the
templates.  These templates are processed by Template Toolkit to
produce the user interface.  For the most part, the files contain
straight-up HTML and can be altered to your heart's content.  You
could probably even pass off the care and feeding of these templates
to a non-technical person (as this was the idea behind having no HTML
in the code).  The only functional parts of the templates lie in
between the many "[% %]" tags, and these are often quite
self-explanatory.  If you can't figure out what to change on your own,
then check out http://www.template-toolkit.com/ for the documentation
(or type "perldoc Template" on your command line).

