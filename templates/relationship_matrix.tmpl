[% 
    INCLUDE header.tmpl 
    title=map_title
    no_link='matrix'
    help_anchor=''
%]

<h1>[% map_title %]</h1>

<form>
    Restrict Reference Studies By:
    <select name="species_id">
        <option value="">--All Species--</option>
        [% FOREACH s=species %]
            <option [% IF s.species_id==apr.param('species_id'); 'selected'; END %] value="[% s.species_id %]">[% s.common_name %]</option>
        [% END %]
    </select>

    &nbsp;

    <select name="map_study_id">
        <option value="">--All Map Studies--</option>
        [% FOREACH ms=map_studies %]
            <option [% IF ms.map_study_id==apr.param('map_study_id'); 'selected'; END %] value="[% ms.map_study_id %]">[% ms.map_study_name %]</option>
        [% END %]
    </select>

    &nbsp;

    <select name="linkage_group">
        <option value="">--All Linkage Groups--</option>
        [% FOREACH lg=linkage_groups %]
            <option [% IF lg.linkage_group==apr.param('linkage_group'); 'selected'; END %] value="[% lg.linkage_group %]">[% lg.linkage_group %]</option>
        [% END %]
    </select>

    &nbsp;

    <input type="hidden" name="prev_species_id"    value="[% apr.param('species_id')    %]">
    <input type="hidden" name="prev_map_study_id"  value="[% apr.param('map_study_id')  %]">
    <input type="hidden" name="prev_linkage_group" value="[% apr.param('linkage_group') %]">
    <input type="submit" value="Submit">
</form>

[% IF matrix.data.size %]

    <table border="1">
        <tr>
            <th colspan="2" rowspan="2">Reference Study</th>
            [% SET no_by_type=top_row.no_by_type %]
            [% SET last_map_type_id=0 %]

            [% FOREACH ms=top_row.map_studies %]
                [% SET map_type_id=ms.map_type_id %]
                [% NEXT IF map_type_id==last_map_type_id %]
                [% SET colspan=no_by_type.$map_type_id %]
                <th colspan="[% colspan %]">[% ms.map_type %]</th>
                [% SET last_map_type_id=map_type_id %]
            [% END %]
            <th colspan="2" rowspan="2">Reference Study</th>
        </tr>
        <tr>
            [% SET no_by_type_and_species=top_row.no_by_type_and_species %]
            [% SET last_map_type_id=0 %]
            [% SET last_species_id=0 %]

            [% FOREACH ms=top_row.map_studies %]
                [% SET species_id=ms.species_id %]
                [% SET map_type_id=ms.map_type_id %]

                [% NEXT IF species_id==last_species_id && map_type_id==last_map_type_id %]

                [% SET colspan=no_by_type_and_species.$map_type_id.$species_id %]
                <th colspan="[% colspan %]">[% ms.species_name %]</th>
                [% SET last_map_type_id=map_type_id %]
                [% SET last_species_id=species_id %]
            [% END %]
        </tr>

        [% SET i=0 %]
        [% SET last_species_id=0 %]
        [% SET no_by_species=matrix.no_by_species %]
        [% FOREACH ms=matrix.data %]
            <tr>
                [% SET species_id=ms.species_id %]

                [% UNLESS ms.species_id==last_species_id %]
                    [% SET rowspan=no_by_species.$species_id %]
                    <th[% IF rowspan > 1 %] rowspan="[% rowspan %]"[% END %]>
                        [% ms.species_name %]
                        [% IF apr.param('map_study_id') %]
                            <br>[% ms.map_study_name | nbsp %]
                        [% END %]
                    </th>
                [% END %]

                <td bgcolor="[% IF i % 2 == 0 %]lightgrey[% ELSE %]white[% END %]">
                    [% IF apr.param('map_study_id') %]
                        [% IF ms.linkage_group %]
                            <b>[% ms.linkage_group %]</b>
                        [% ELSE %]
                            <b>All</b>
                        [% END %]
                    [% ELSE %]
                        <a href="/maps/matrix?species_id=[% apr.param('species_id') %];map_study_id=[% ms.map_study_id %]">[% ms.map_study_name | nbsp %]</a>
                    [% END %]
                </td>

                [% FOREACH r=ms.relationships %]
                    <td align="center" bgcolor="[% IF i % 2 == 0 %]lightgrey[% ELSE %]white[% END %]">
                        [% IF r.number=='N/A' OR r.number==0 %]
                            [% r.number %]
                        [% ELSE %]
                            [% IF apr.param('map_study_id') %]
                                <a href="/maps/viewer?reference_map_study_id=[% ms.map_study_id %];reference_map_id=[% ms.genetic_map_id %];[% IF r.genetic_map_id %]comparative_map1=genetic_map_id%3d[% r.genetic_map_id %][% ELSE %]comparative_map1=map_study_id%3d[% r.map_study_id %][% END %]">[% r.number %]</a>
                            [% ELSE %]
                                <a href="/maps/matrix?species_id=[% apr.param('species_id') %];linkage_group=[% apr.param('linkage_group') %];map_study_id=[% ms.map_study_id %];link_map_study_id=[% r.map_study_id %]">[% r.number %]</a>
                            [% END %]
                        [% END %]
                    </td>
                [% END %]

                <td bgcolor="[% IF i % 2 == 0 %]lightgrey[% ELSE %]white[% END %]">
                    [% IF apr.param('map_study_id') %]
                        [% IF ms.linkage_group %]
                            <b>[% ms.linkage_group %]</b>
                        [% ELSE %]
                            <b>All</b>
                        [% END %]
                    [% ELSE %]
                        <a href="/maps/matrix?species_id=[% apr.param('species_id') %];map_study_id=[% ms.map_study_id %]">[% ms.map_study_name | nbsp %]</a>
                    [% END %]
                </td>

                [% UNLESS ms.species_id==last_species_id %]
                    [% SET rowspan=no_by_species.$species_id %]
                    <th[% IF rowspan > 1 %] rowspan="[% rowspan %]"[% END %]>
                        [% ms.species_name %]
                        [% IF apr.param('map_study_id') %]
                            <br>[% ms.map_study_name | nbsp %]
                        [% END %]
                    </th>
                [% END %]

                [% SET last_species_id=ms.species_id %]
            </tr>
            [% SET i = i + 1 %]
        [% END %]

        [% IF apr.param('link_map_study_id') %]
            [% SET no_columns=0 %]
            [% SET map_study_name="" %]
            <tr>
                <td colspan="2">&nbsp;</td>
                [% FOREACH lg=top_row.map_studies %]
                    <th>
                        [% lg.linkage_group %]
                    </th>
                    [% SET no_columns=no_columns+1 %]
                    [% SET map_study_name=lg.map_study_name %]
                [% END %]
                <td colspan="2">&nbsp;</td>
            </tr>

            <tr>
                <td colspan="2">&nbsp;</td>
                <th colspan="[% no_columns %]">[% map_study_name %]</th>
                <td colspan="2">&nbsp;</td>
            </tr>

        [% ELSE %]
            <tr>
                <td colspan="2">&nbsp;</td>
                [% FOREACH ms=top_row.map_studies %]
                    <td>
                        <a href="/maps/matrix?map_study_id=[% apr.param('map_study_id') %];species_id=[% apr.param('species_id') %];linkage_group=[% apr.param('linkage_group') %];link_map_study_id=[% ms.map_study_id %]">[% ms.map_study_name %][% IF ms.genetic_map_id %][% END %]</a>
                    </td>
                [% END %]
                <td colspan="2">&nbsp;</td>
            </tr>
        [% END %]
    </table>

[% ELSE %]

    No relationships for those criteria.

[% END %]

<!-- pre>[% dump %]</pre -->

[% page.end_body OR '</body>' %]
</html>
