[% 
  INCLUDE header.tmpl 
  title=title
  cur_sec='map_viewer'
  help_anchor='map_viewer'
  body_addendum='onLoad="setDivObjects();document.comparative_map_form.reset()"'
%]
<script language="javascript">
                                        
function setDivObjects(){
  startPage();
}

function toggleDiv(obj){
  if (obj.style.display == 'block'){
    obj.style.display = 'none';
    return "0";
  }
  else{
    obj.style.display = 'block';
    return "1";
  }
}

function setMenuObjects(obj1,obj2,txt){
    obj1.value=txt;
    obj2.value=txt;
    return 1;
}

function hideAll(){
  var divs=document.getElementsByTagName("DIV");
  for (var i=0; i < divs.length; i++){
    if (divs[i].id.search(/^display/)>=0){
      divs[i].style.display='none';
    }
    else if (divs[i].id.search(/^hidden/)>=0){
      divs[i].style.display='block';
    }
  }
}

function startPage(){
  var divs=document.getElementsByTagName("DIV");
  for (var i=0; i < divs.length; i++){
    if (divs[i].id == "displayChangeMenu"){
        if ("[% apr.param('changeMenu') %]" == "1"){
            divs[i].style.display='block';
        }
        else{
            divs[i].style.display='none';
        }
    }
    else if (divs[i].id == "hiddenChangeMenu"){
        if ("[% apr.param('changeMenu') %]" == "1"){
            divs[i].style.display='none';
        }
        else{
            divs[i].style.display='block';
        }
    }
    else if (divs[i].id == "displayCompMenu"){
        if ("[% apr.param('compMenu') %]" == "1"){
            divs[i].style.display='block';
        }
        else{
            divs[i].style.display='none';
        }
    }
    else if (divs[i].id == "hiddenCompMenu"){
        if ("[% apr.param('compMenu') %]" == "1"){
            divs[i].style.display='none';
        }
        else{
            divs[i].style.display='block';
        }
    }
    else if (divs[i].id == "displayOptionMenu"){
        if ("[% apr.param('optionMenu') %]" == "1"){
            divs[i].style.display='block';
        }
        else{
            divs[i].style.display='none';
        }
    }
    else if (divs[i].id == "hiddenOptionMenu"){
        if ("[% apr.param('optionMenu') %]" == "1"){
            divs[i].style.display='none';
        }
        else{
            divs[i].style.display='block';
        }
    }
    else if (divs[i].id == "displayImageMenu"){
        if ("[% apr.param('imageMenu') %]" == "1"){
            divs[i].style.display='block';
        }
        else{
            divs[i].style.display='none';
        }
    }
    else if (divs[i].id == "hiddenImageMenu"){
        if ("[% apr.param('imageMenu') %]" == "1"){
            divs[i].style.display='none';
        }
        else{
            divs[i].style.display='block';
        }
    }
  }
} 

function selectFeatureRadio(val){
  var radios=document.getElementsByTagName("INPUT");
  for (var i=0; i < radios.length; i++){
    if (radios[i].name.search(/^feature_type_/)>=0){
      if (radios[i].value==val){
        radios[i].checked=true;
      }
      else{
        radios[i].checked=false;
      }
    }
  }
}

function selectEvidenceRadio(val){
  var radios=document.getElementsByTagName("INPUT");
  for (var i=0; i < radios.length; i++){
    if (radios[i].name.search(/^evidence_type_/)>=0){
      if (radios[i].value==val){
        radios[i].checked=true;
      }
      else{
        radios[i].checked=false;
      }
    }
  }
}

function mod_map_info(slot_no, map_aid, start, stop,mag){
  if ( slot_no == 0){
    if (start!='' && start==stop){
      document.comparative_map_form.modified_ref_map.value='';
    }
    else{
      document.comparative_map_form.modified_ref_map.value
        =map_aid+"["+start+"*"+stop+"x"+mag+"]";
    }
  }
  else{
    if (start!='' && start==stop){
    document.comparative_map_form.modified_comp_map.value=''
    }
    else{
    document.comparative_map_form.modified_comp_map.value
      =slot_no+"=map_aid="+map_aid+"["+start+"*"+stop+"x"+mag+"]";
    }
  }
}

function changeCompMaps(sel,index,side){
  var dataArray;
  var map_sets;
  if (side == 'Left'){
    dataArray=new Array(
      [% SET not_first_map_set=0; -%]
      [%- FOREACH ms=form_data.comparative_maps_left -%]
        [%- IF not_first_map_set -%]
          ,
        [%- ELSE -%]
          [%- SET not_first_map_set=1; -%] 
        [%- END -%]
        [%- SET not_first_map=0; -%]
        new Array( 
        [% FOREACH map=ms.maps; -%]
          [%- IF not_first_map -%]
            ,
          [%- ELSE -%]
            [%- SET not_first_map=1; -%] 
          [%- END -%]
          new Array( '[%- map.map_name %] [[% map.no_correspondences %]]','[% map.map_aid -%]')
        [% END -%]
        )
      [% END -%]
    );
  }
  else{
    dataArray=new Array(
      [% SET not_first_map_set=0; -%]
      [%- FOREACH ms=form_data.comparative_maps_right -%]
        [%- IF not_first_map_set -%]
          ,
        [%- ELSE -%]
          [%- SET not_first_map_set=1; -%] 
        [%- END -%]
        [%- SET not_first_map=0; -%]
        new Array( 
        [% FOREACH map=ms.maps; -%]
          [%- IF not_first_map -%]
            ,
          [%- ELSE -%]
            [%- SET not_first_map=1; -%] 
          [%- END -%]
          new Array( '[%- map.map_name %] [[% map.no_correspondences %]]','[% map.map_aid -%]')
        [% END -%]
        )
      [%- END -%]
    );
  }

  var mapSetArray=dataArray[index]
  var length=mapSetArray.length;
  var i;
  for (i=length;i<sel.options.length;i++){
    sel.options[i]=null;
    i--;
  }
  if (sel.options.length<=0){
    sel.options[sel.options.length] = new Option("== ALL ==",-1);
  }
  else{
    sel.options[0].value=-1;
    sel.options[0].text="== ALL ==";
  }
  for (i=0;i<length;i++){
    if (sel.options.length<=i+1){
      var opt = new Option(mapSetArray[i][0],mapSetArray[i][1]);
      sel.options[sel.options.length] = opt;
    }
    else{
      sel.options[i+1].value=mapSetArray[i][1];
      sel.options[i+1].text=mapSetArray[i][0];
    }
  }
  sel.selectedIndex=0;
}



</script>
[%- IF extra_code -%]
  [% extra_code %]
[%- END -%]

[%- IF intro -%]
<p>[% intro %]</p>
[%- END -%]

<table border="0"> 
  <tr>
    <td align="left" valign="top">
      <div id="hiddenChangeMenu">
        <span  
          onclick="toggleDiv(document.getElementById('hiddenChangeMenu'));
          setMenuObjects(
          window.document.ref_map_set_form.changeMenu,
          window.document.comparative_map_form.changeMenu,
          toggleDiv(document.getElementById('displayChangeMenu')));"
        >
        <img src="/cmap/plus.png">&nbsp;<b>Click to Show Change Menu</b>
        </span>
      </div>
      <div id="displayChangeMenu">
        <span  
          onclick="setMenuObjects(
          window.document.ref_map_set_form.changeMenu,
          window.document.comparative_map_form.changeMenu,
          toggleDiv(document.getElementById('displayChangeMenu')));
          toggleDiv(document.getElementById('hiddenChangeMenu'));"
        >
        <img src="/cmap/minus.png">&nbsp;<b>Hide Menu</b>
        </span>
 
        <table border="0">
          <form name="ref_map_set_form">
          <input type="hidden" name="changeMenu" id="changeMenu" value="[% apr.param('changeMenu') %]">
          <input type="hidden" name="compMenu" id="compMenu" value="[% apr.param('compMenu') %]">
          <input type="hidden" name="optionMenu" id="optionMenu" value="[% apr.param('optionMenu') %]">
          <input type="hidden" name="imageMenu" id="imageMenu" value="[% apr.param('imageMenu') %]">
          <tr>
            <td align="right">Ref. Species:</td>
  
            <td>
              [%- IF form_data.ref_species.size -%]
                <select name="ref_species_aid" 
                  onChange="window.document.ref_map_set_form.ref_map_set_aid.value='';javascript:ref_map_set_form.submit()">
                <option value="">--Select--</option>
                [%- IF form_data.ref_species.size > 1; 
                  form_data.ref_species.unshift({ 
                    species_aid => -1, 
                    species_common_name => 'All Species' });
                END -%]
                [%- FOREACH s=form_data.ref_species -%]
                  <option value="[% s.species_aid %]"[% IF s.species_aid==apr.param('ref_species_aid') OR form_data.ref_species.size==1; ' selected'; END %]>[% s.species_common_name %][% IF s.species_full_name %] ([% s.species_full_name %])[% END %]</option>
                [%- END -%]
                </select>
                <input type="submit" value="Change" name="sub">
              [%- ELSE -%]
                No species.
              [%- END -%]
            </td>
          </tr>
          
          [% IF form_data.ref_map_sets.size %]
            <tr>
              <td align="right">Ref. Set:</td>

              <td>
                [% SET last_map_type='' %]
                <select name="ref_map_set_aid" onChange="javascript:ref_map_set_form.submit()">
                  <option value="">--Select--</option>
                  [%- FOREACH ms=form_data.ref_map_sets -%]
                    [%- IF ms.map_type != last_map_type -%]
                      <option value="">--&nbsp;[% ms.map_type %]&nbsp;Maps&nbsp;--</option>
                    [%- END -%]
[% apr.param('ref_map_set_aid') %] == [% ms.accession_id %]
                    <option [% IF apr.param('ref_map_set_aid') == ms.accession_id OR form_data.ref_map_sets.size==1; apr.param('ref_map_set_aid') = ms.accession_id; ' selected'; END %] value="[% ms.accession_id %]">
                      [% ms.species_name %] - [% ms.map_set_name %]
                    </option>
                    [%- SET last_map_type=ms.map_type -%]
                  [%- END -%]
                </select>&nbsp;<input type="submit" value="Change" name="sub">
                <input type="hidden" name="prev_ref_species_aid" value="[% apr.param('ref_species_aid') %]">
                <input type="hidden" name="prev_ref_map_set_aid" value="[% apr.param('ref_map_set_aid') %]">
                <input type="hidden" name="highlight"      value="[% apr.param('highlight') %]">
                <input type="hidden" name="image_size"       value="[% apr.param('image_size') %]">
                <input type="hidden" name="image_type"       value="[% apr.param('image_type') %]">
                <input type="hidden" name="data_source"      value="[% data_source %]">
              </td>
            </tr>
          [% END %]
          </form>
          [% IF form_data.ref_maps %]
            [% form_data.ref_maps.unshift({accession_id=>'-1',map_name=>'--All--'}) %]
            <form name="ref_map_form">
              <input type="hidden" name="changeMenu" id="changeMenu" value="[% apr.param('changeMenu') %]">
              <input type="hidden" name="compMenu" id="compMenu" value="[% apr.param('compMenu') %]">
              <input type="hidden" name="optionMenu" id="optionMenu" value="[% apr.param('optionMenu') %]">
              <input type="hidden" name="imageMenu" id="imageMenu" value="[% apr.param('imageMenu') %]">
              <tr>
                <td valign="top" align="right">Ref. Map:</td>
      
                <td>
                  <select name="ref_map_aids" size="14" multiple
                    [% IF apr.param('ref_map_aids') %]
                      onchange="javascript:if(document.ref_map_form.ref_map_aids.value!=document.ref_map_form.prev_ref_map_aids.value){document.comparative_map_form.start.value='';document.comparative_map_form.end.value='';document.ref_map_form.submit()}">
                    [% ELSE %]
                      onchange="javascript:if(document.ref_map_form.ref_map_aids.value!=document.ref_map_form.prev_ref_map_aids.value){document.ref_map_form.submit()}">
                    [% END %]
    
                    [% IF form_data.ref_maps.size %]
                      <option value="">--Select a Map--</option>
                      [% FOREACH m=form_data.ref_maps %]
                        <option[% IF selected_maps.${m.accession_id} OR form_data.ref_maps.size==1; ' selected'; END %] value="[% m.accession_id %]">[% m.map_name %]</option>
                      [% END %]
                    [% ELSE %]
                      <option value="">--No Maps Available--</option>
                    [% END %]
                  </select>
    
                  <input type="hidden" name="prev_ref_species_aid" value="[% apr.param('ref_species_aid') %]">
                  <input type="hidden" name="prev_ref_map_aids" value="[% apr.param('ref_map_aids') %]">
                  <input type="hidden" name="ref_map_set_aid"  value="[% apr.param('ref_map_set_aid') %]">
                  <input type="hidden" name="ref_species_aid"  value="[% apr.param('ref_species_aid') %]">
                  <input type="hidden" name="data_source"      value="[% data_source %]">
                  [% IF apr.param('comparative_map_field1') %]
                    <input type="hidden" name="comparative_map1" value="[% apr.param('comparative_map_field1') %]=[% apr.param('comparative_map_value1') %]">
                    <input type="hidden" name="image_size"     value="[% apr.param('image_size') %]">
                    <input type="hidden" name="image_type"     value="[% apr.param('image_type') %]">
                  [% END %]
                </td>
              </tr>
              <tr>
                <td align="right">Ref Map Names:</td>
                <td>
                  <input name="ref_map_names" value="[% apr.param('ref_map_names') %]">
                </td>
              </tr>
              <tr>
                <td align="center" colspan="2">
                  <input type="submit" value="Change Maps" name="sub">
                </td>
              </tr>
            </form>
          [% END %]
        </table>
      </div>
    </td>
  </tr>
  [% IF apr.param('ref_map_aids') OR apr.param('ref_map_names') OR form_data.ref_maps  %]
    <form name="comparative_map_form">
      <tr>
        <td align=left valign=top>
          <input type="hidden" name="changeMenu" id="changeMenu" value="[% apr.param('changeMenu') %]">
          <input type="hidden" name="compMenu" id="compMenu" value="[% apr.param('compMenu') %]">
          <input type="hidden" name="optionMenu" id="optionMenu" value="[% apr.param('optionMenu') %]">
          <input type="hidden" name="imageMenu" id="imageMenu" value="[% apr.param('imageMenu') %]">
          <div id="hiddenCompMenu">
            <span  
              onclick="toggleDiv(document.getElementById('hiddenCompMenu'));
              setMenuObjects(
              window.document.ref_map_set_form.compMenu,
              window.document.comparative_map_form.compMenu,
              toggleDiv(document.getElementById('displayCompMenu')));"
            >
            <img src="/cmap/plus.png">&nbsp;<b>Click to Show Comparison Menu</b>
            </span>
          </div>
          <div id="displayCompMenu">
            <span  
              onclick="setMenuObjects(
              window.document.ref_map_set_form.compMenu,
              window.document.comparative_map_form.compMenu,
              toggleDiv(document.getElementById('displayCompMenu')));
              toggleDiv(document.getElementById('hiddenCompMenu'));"
            >
              <img src="/cmap/minus.png">&nbsp;<b>Hide Menu</b>
            </span>
            <table>
              <tr>
                <td align="right" valign="top">
                  <table border="0">
                    <tr>
                      [% PROCESS 'cmap_viewer_comparative_map_select.tmpl'
                        side="Left"
                        map_sets=form_data.comparative_maps_left
                      %]
                    </tr>
                  </table>
                </td> 
                <td align="center" valign="top">
                  <table border="0">
                    <tr>
                      <td align="right">Start:</td>
  
                      <td>
                        <input name="ref_map_start" value="[% apr.param('ref_map_start') %]">
                      </td>
                    </tr>
              
                    <tr>
                      <td align="right">End:</td>
                      <td>
                        <input name="ref_map_stop" value="[% apr.param('ref_map_stop') %]">
                      </td>
                    </tr>
              
                    <tr>
                      <td align="right">Highlight:</td>
  
                      <td>
                        <input name="highlight" value="[% apr.param('highlight') | html %]">
                      </td>
                    </tr>

                    <tr>
                      <td align="right" valign="top">Current Maps:</td>
                      <td>
                        [% FOREACH map=form_data.map_info %]
                          [% SET cmaps=[] %]
                          [% FOREACH cmap=map.cmaps %]
                            [% cmaps.push( "${cmap.slot_no}%3d${cmap.field}%3d${cmap.aid}" ) %]
                          [% END %]
                          [% map.description %][% IF map.is_reference_map %]&nbsp;(Ref.)[% ELSE %]&nbsp;[&nbsp;<a href="viewer?ref_map_set_aid=[% apr.param('ref_map_set_aid') %];ref_map_aids=[% apr.param('ref_map_aids') %];ref_map_start=[% apr.param('ref_map_start') %];ref_map_stop=[% apr.param('ref_map_stop') %];comparative_maps=[% cmaps.join('%3a') %];include_feature_types=[% feature_types %];included_evidence_types=[% evidence_types %];collapse_features=[% apr.param('collapse_features') %];image_type=[% apr.param('image_type') %];min_correspondences=[% apr.param('min_correspondences') %]">Delete</a>&nbsp;]&nbsp;[% END %]<br>
                        [% END %]
                      </td>
                    </tr>
                    <tr>
                      <td align="right">Min. No. Correspondences:</td> 
                      <td><input name="min_correspondences" value="[% apr.param('min_correspondences') %]"> </td>
                    </tr>
                    <tr>
                      <td align="right"> <input type="submit" value="Redraw Map" name="sub"></td>
                      <td><input type="reset"  value="Reset"></td>
                    </tr>
                  </table>
                </td>
                <td align=left valign=top>
                  <table border=0>
                    <tr>
                      [% PROCESS 'cmap_viewer_comparative_map_select.tmpl'
                        side="Right"
                        map_sets=form_data.comparative_maps_right
                      %]
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </div>
        </td>
      </tr>
      <tr>
        <td align=left valign=top>
          <div id="hiddenOptionMenu">
            <span  
              onclick="toggleDiv(document.getElementById('hiddenOptionMenu'));
              setMenuObjects(
              window.document.ref_map_set_form.optionMenu,
              window.document.comparative_map_form.optionMenu,
              toggleDiv(document.getElementById('displayOptionMenu')));"
            >
             <img src="/cmap/plus.png">&nbsp;<b>Click to Show Options Menu</b>
            </span>
          </div>
          <div id="displayOptionMenu">
            <span  
              onclick="setMenuObjects(
              window.document.ref_map_set_form.optionMenu,
              window.document.comparative_map_form.optionMenu,
              toggleDiv(document.getElementById('displayOptionMenu')));
              toggleDiv(document.getElementById('hiddenOptionMenu'));"
            >
              <img src="/cmap/minus.png">&nbsp;<b>Hide Menu</b>
            </span>
            <table>
              <tr>
                <td align="left" valign="bottom" colspan="2"><b>Feature Types:</b></td>
              </tr>
              <tr>
                <td colspan="2" align="left">
                  <table border="1">
                    <tr>
                      <td>Feature</td>
                      <td>Ignore</td>
                      <td>Display if<br>Correspondence</td>
                      <td>Always Display</td>
                    </tr>
                    [% FOREACH ft=form_data.feature_types %]
                      <tr>
                        <td>[% ft.feature_type %]</td>
                        <td>
                          <input type="radio" name="feature_type_[% ft.feature_type_aid %]" value="0" [% IF (ignored_feature_types.${ft.feature_type_aid} OR (feature_default_display=='ignore' AND NOT included_features.${ft.feature_type_aid} AND NOT corr_only_feature_types.${ft.feature_type_aid})) ; ' checked'; END %]>
                        </td>
                        <td>
                          <input type="radio" name="feature_type_[% ft.feature_type_aid %]" value="1" [% IF (corr_only_feature_types.${ft.feature_type_aid} OR (feature_default_display=='corr_only' AND NOT included_features.${ft.feature_type_aid} AND NOT ignored_feature_types.${ft.feature_type_aid})); ' checked'; END %]>
                        </td>
                        <td>
                          <input type="radio" name="feature_type_[% ft.feature_type_aid %]" value="2" [% IF (included_features.${ft.feature_type_aid} OR (feature_default_display=='display' AND NOT corr_only_feature_types.${ft.feature_type_aid} AND NOT ignored_feature_types.${ft.feature_type_aid})); ' checked'; END %]>
                        </td>
                      </tr>
                    [% END %]
                    <tr>
                      <td>&nbsp;</td>
                      <td><input type="button" name="checkColumn" value="Check All" onClick="selectFeatureRadio(0)"></td>
                      <td><input type="button" name="checkColumn" value="Check All" onClick="selectFeatureRadio(1)"></td>
                      <td><input type="button" name="checkColumn" value="Check All" onClick="selectFeatureRadio(2)"></td>
                    </tr>
                  </table> 
                </td>
              </tr>
              <tr>
                <td align="left" valign="bottom"><b>Include Correspondence Types:</b></td>
              </tr>
              <tr>
                <td>
                  [% IF form_data.evidence_types.size %]
                    <table border="1">
                      <tr>
                        <td>Evidence</td>
                        <td>Ignore</td>
                        <td>Use</td>
                      </tr>
                      [% FOREACH et=form_data.evidence_types %]
                        <tr>
                          <td>[% et.evidence_type %]</td>
                        <td>
                          <input type="radio" name="evidence_type_[% et.evidence_type_aid %]" value="0" [% IF ignored_evidence_types.${et.evidence_type_aid}; ' checked'; END %]>
                        </td>
                        <td>
                          <input type="radio" name="evidence_type_[% et.evidence_type_aid %]" value="1" [% IF NOT ignored_evidence_types.${et.evidence_type_aid}; ' checked'; END %]>
                        </td>
                      </tr>
                    [% END %]
                    <tr>
                      <td>&nbsp;</td>
                      <td><input type="button" name="checkColumn" value="Check All" onClick="selectEvidenceRadio(0)"></td>
                      <td><input type="button" name="checkColumn" value="Check All" onClick="selectEvidenceRadio(1)"></td>
                    </tr>
                  </table> 
                  [% ELSE %]
                    There are no evidence types!
                  [% END %]
                </td>
              </tr>
              <tr>
                <td align="left" valign="top">Aggregate Correspondences:
                  [% IF apr.param('aggregate')==0; aggregate=0; ELSE; aggregate=1; END %]
                  [% IF apr.param('aggregate')==2; aggregate=2; END %]
                  <input type="radio" name="aggregate" value="0"[% IF aggregate==0; ' checked'; END %]>No
                  <input type="radio" name="aggregate" value="1"[% IF aggregate==1; ' checked'; END %]>1 Line
                  <input type="radio" name="aggregate" value="2"[% IF aggregate==2; ' checked'; END %]>2 Lines
                </td>
              </tr>
              <tr>
                <td align="left" valign="top">Total Magnification: 
                  <select name="magnify_all" >
                    <option value="0.125"[% IF 0.125==apr.param('magnify_all'); ' selected'; END %]>1/8</option>
                    <option value="0.25"[% IF 0.25==apr.param('magnify_all'); ' selected'; END %]>1/4</option>
                    <option value="0.5"[% IF 0.5==apr.param('magnify_all'); ' selected'; END %]>1/2</option>
                    <option value="1"[% IF 1==apr.param('magnify_all') OR NOT apr.param('magnify_all'); ' selected'; 
                                       END %]>Original Magnification</option>
                    <option value="2"[% IF 2==apr.param('magnify_all'); ' selected'; END %]>2</option>
                    <option value="3"[% IF 3==apr.param('magnify_all'); ' selected'; END %]>3</option>
                    <option value="4"[% IF 4==apr.param('magnify_all'); ' selected'; END %]>4</option>
                    <option value="5"[% IF 5==apr.param('magnify_all'); ' selected'; END %]>5</option>
                    <option value="10"[% IF 10==apr.param('magnify_all'); ' selected'; END %]>10</option>
                    <option value="20"[% IF 20==apr.param('magnify_all'); ' selected'; END %]>20</option>
                  </select>
                </td>
              </tr>
            </table>
          </div>
        </td>
      </tr>
      <tr>
        <td><hr>
          <input type="submit" value="Redraw Map" name="sub">
          <input type="reset"  value="Reset">
        </td>
      </tr>
      <tr>
        [% IF drawer.image_name %]
          <td valign="top">
            [% IF drawer.image_type=='svg' %]
              <object type="image/svg+xml" data="/cmap/tmp/[% drawer.image_name %]" height="[% drawer.map_height %]" width="[% drawer.map_width %]"></object>
            [% ELSE %]
              <img src="/cmap/tmp/[% drawer.image_name %]" height="[% drawer.map_height %]" width="[% drawer.map_width %]" usemap="#zoom" border="0">
            [% END %]
          </td>
        [% END %]
      </tr>
      <tr>
        <td align=left valign=top>
          <div id="hiddenImageMenu">
            <span  
              onclick="toggleDiv(document.getElementById('hiddenImageMenu'));
              setMenuObjects(
              window.document.ref_map_set_form.imageMenu,
              window.document.comparative_map_form.imageMenu,
              toggleDiv(document.getElementById('displayImageMenu')));"
            >
            <img src="/cmap/plus.png">&nbsp;<b>Click to Show Additional Options Menu</b>
            </span>
          </div>
          <div id="displayImageMenu">
            <span  
              onclick="setMenuObjects(
              window.document.ref_map_set_form.imageMenu,
              window.document.comparative_map_form.imageMenu,
              toggleDiv(document.getElementById('displayImageMenu')));
              toggleDiv(document.getElementById('hiddenImageMenu'));"
            >
              <img src="/cmap/minus.png">&nbsp;<b>Hide Menu</b>
            </span>

            <table border="0">
              <tr>
                <td align="left" valign="top">Image Size:</td>
                <td>
                  <input type="radio" name="image_size" value="small"[% IF apr.param('image_size') == 'small'; ' checked'; END %]>Small
                </td>
                <td>
                  <input type="radio" name="image_size" value="medium"[% IF apr.param('image_size') == 'medium'; ' checked'; END %]>Medium
                </td>
                <td>
                  <input type="radio" name="image_size" value="large"[% IF apr.param('image_size') == 'large'; ' checked'; END %]>Large
                </td>
              </tr>
          
              <tr>
                <td align="left" valign="top">Font Size:</td>
  
                <td>
                  <input type="radio" name="font_size" value="small"[% IF apr.param('font_size') == 'small'; ' checked'; END %]>Small
                </td>
                <td>
                  <input type="radio" name="font_size" value="medium"[% IF apr.param('font_size') == 'medium'; ' checked'; END %]>Medium
                </td>
                <td>
                  <input type="radio" name="font_size" value="large"[% IF apr.param('font_size') == 'large'; ' checked'; END %]>Large
                </td>
              </tr>
            
              <tr>
                <td align="left" valign="top">Image Type:</td>
  
                <td>
                  <input type="radio" name="image_type" value="png"[% IF apr.param('image_type') == 'png'; ' checked'; END %]>PNG
                </td>
                <td>
                  <input type="radio" name="image_type" value="jpeg"[% IF apr.param('image_type') == 'jpeg'; ' checked'; END %]>JPEG
                </td>
                <td>
                  <input type="radio" name="image_type" value="gif"[% IF apr.param('image_type') == 'gif'; ' checked'; END %]>GIF
                </td>
                <td>
                  <input type="radio" name="image_type" value="svg"[% IF apr.param('image_type') == 'svg'; ' checked'; END %]>SVG *
                </td>
              </tr>
  
              <tr>
                <td align="left" valign="top">Show Labels:</td>

                <td>
                  <input type="radio" name="label_features" value="none"[% IF apr.param('label_features')=='none'; ' checked'; END %]>None
                </td>
                <td>
                  <input type="radio" name="label_features" value="landmarks"[% IF apr.param('label_features')=='landmarks'; ' checked'; END %]>Landmarks
                </td>
                <td>
                  <input type="radio" name="label_features" value="all"[% IF apr.param('label_features')=='all'; ' checked'; END %]>All
                </td>
              </tr>
  
              <tr>
                <td align="Left" valign="top">Collapse Overlapping <br>Features:</td>
  
                <td>
                  [% IF apr.param('collapse_features')==1; collapse=1; ELSE; collapse=0; END %]
                  <input type="radio" name="collapse_features" value="0"[% IF collapse==0; ' checked'; END %]>No
                </td>
                <td>
                  <input type="radio" name="collapse_features" value="1"[% IF collapse==1; ' checked'; END %]>Yes
                </td>
              </tr>
              <tr>
                <td align="left" valign="top">Draw Maps to Scale:</td>
                [% IF apr.param('scale_maps')==0; scale_maps=0; ELSE; scale_maps=1; END %]
                <td><input type="radio" name="scale_maps" value="0"[% IF scale_maps==0; ' checked'; END %]>No</td>
                <td><input type="radio" name="scale_maps" value="1"[% IF scale_maps==1; ' checked'; END %]>Yes</td>
              </tr>
              <tr>
                <td align="left" valign="top">Clean View (no navigation buttons):
                  [% IF apr.param('clean_view')==1; clean_view=1; ELSE; clean_view=0; END %]
                  <input type="radio" name="clean_view" value="0"[% IF clean_view==0; ' checked'; END %]>No
                  <input type="radio" name="clean_view" value="1"[% IF clean_view==1; ' checked'; END %]>yes
                </td>
              </tr>
              <tr>
                <td colspan=4>
                  <input type="submit" value="Redraw Map" name="sub">
                  <input type="reset"  value="Reset">
                </td>
              </tr>
              <tr>
                <td colspan="4" align="center">
                  <input type="hidden" name="ref_map_set_aid" value="[% apr.param('ref_map_set_aid') %]">
                  <input type="hidden" name="ref_map_aids"   value="[% apr.param('ref_map_aids').join(',') %]">
                  <input type="hidden" name="modified_ref_map"   value="">
                  <input type="hidden" name="ref_map_names"   value="[% apr.param('ref_map_names') %]">
                  <input type="hidden" name="ref_species_aid"  value="[% apr.param('ref_species_aid') %]">
                  <input type="hidden" name="comparative_maps" value="[% comparative_maps %]">
                  <input type="hidden" name="modified_comp_map"   value="">
                  <input type="hidden" name="flip"      value="[% apr.param('flip') %]">
                  <input type="hidden" name="data_source"      value="[% data_source %]">
                  <br>
                  <em><b>*</b>SVG output for high-resolution 
                  printing only (no hyperlinks).</em>
                </td>
              </tr>
            </table>
          </div>
          [%- IF extra_form -%]
            [% extra_form %]
          [%- END -%]
        </td>
      </tr>
    </form>
  [% ELSE %]
    <form name="comparative_map_form">
      <input type="hidden" name="changeMenu" id="changeMenu" value="[% apr.param('changeMenu') %]">
      <input type="hidden" name="compMenu" id="compMenu" value="[% apr.param('compMenu') %]">
      <input type="hidden" name="optionMenu" id="optionMenu" value="[% apr.param('optionMenu') %]">
      <input type="hidden" name="imageMenu" id="imageMenu" value="[% apr.param('imageMenu') %]">
    </form>
  [% END %]    
</table>

[% IF drawer AND drawer.image_type!='svg' %]
  <map name="zoom">
  [% FOREACH area=drawer.image_map_data -%]
    <area [% area.code %] coords="[% area.coords.join(',') %]" [% IF area.url %]href="[% area.url %]" [% END %]title="[% area.alt %]">
  [% END -%]
  </map>
[% END -%]

[% IF form_data.ref_map_set_info %]
  <hr>
  <table width="700">
    <tr>
      <th colspan="2" align="center" valign="top">Reference Map Set Info</th>
    </tr>
    <tr>
      <th align="right" valign="top">Map&nbsp;Set:</th>
      <td>
        [% form_data.ref_map_set_info.map_set_name %]
        ([% form_data.ref_map_set_info.short_name %])
        <b>[</b>&nbsp;<a href="map_set_info?map_set_aid=[% form_data.ref_map_set_info.map_set_aid %]">View More Info</a>&nbsp;<b>]</b>
      </td>
    </tr>
    <tr>
      <th align="right" valign="top">Species:</th>
      <td>
        [% form_data.ref_map_set_info.species_common_name %]
        ([% form_data.ref_map_set_info.species_full_name %])
        <b>[</b>&nbsp;<a href="species_info?species_aid=[% form_data.ref_map_set_info.species_aid %]">View More Info</a>&nbsp;<b>]</b>
      </td>
    </tr>
    <tr>
      <th align="right" valign="top">Map&nbsp;Type:</th>
      <td>
        [% form_data.ref_map_set_info.map_type %]
        ([% form_data.ref_map_set_info.map_units %])
        <b>[</b>&nbsp;<a href="map_type_info?map_type_aid=[% form_data.ref_map_set_info.map_type_aid %]">View More Info</a>&nbsp;<b>]</b>
      </td>
    </tr>
    [% FOREACH att=form_data.ref_map_set_info.attributes %]
      [% NEXT UNLESS att.is_public %]
      <tr>
        <th align="right" valign="top">
          [% att.attribute_name | nbsp %]:
        </th>
        <td>
          [%- IF att.attribute_value.match('^http://') -%]
            <a href="[% att.attribute_value %]">[% att.attribute_value %]</a>
          [%- ELSE -%]
            [% att.attribute_value %]
          [%- END -%]
        </td>
      </tr>
    [% END %]
    [% IF form_data.ref_map_set_info.xrefs.size %]
      <tr>
        <th align="right" valign="top">Cross-references:</th>
        <td>
          <ul>
          [% FOREACH xref=form_data.ref_map_set_info.xrefs %]
            <li><a href="[% xref.xref_url %]">[% xref.xref_name %]</a></li>
          [% END %]
          </ul>
        </td>
      </tr>
    [% END %]
  </table>
[% END %]

[% UNLESS apr.param('ref_map_aids') OR apr.param('ref_map_names') OR form_data.ref_map_set_info %]
  [% INCLUDE help_quick_start.tmpl %]
[% END %]

[% INCLUDE footer.tmpl %]
